# åœ¨ JAX ä¸­è¿›è¡Œè¿è¡Œæ—¶å€¼è°ƒè¯•

> åŸæ–‡ï¼š[`jax.readthedocs.io/en/latest/debugging/index.html`](https://jax.readthedocs.io/en/latest/debugging/index.html)

æ˜¯å¦é‡åˆ°æ¢¯åº¦çˆ†ç‚¸ï¼ŸNaN ä½¿ä½ ç‰™é½¿å’¬ç´§ï¼Ÿåªæƒ³æŸ¥çœ‹è®¡ç®—ä¸­é—´å€¼ï¼Ÿè¯·æŸ¥çœ‹ä»¥ä¸‹ JAX è°ƒè¯•å·¥å…·ï¼æœ¬é¡µæä¾›äº† TL;DR æ‘˜è¦ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥ç‚¹å‡»åº•éƒ¨çš„â€œé˜…è¯»æ›´å¤šâ€é“¾æ¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚

ç›®å½•ï¼š

+   ä½¿ç”¨ `jax.debug` è¿›è¡Œäº¤äº’å¼æ£€æŸ¥

+   ä½¿ç”¨ jax.experimental.checkify è¿›è¡ŒåŠŸèƒ½é”™è¯¯æ£€æŸ¥

+   ä½¿ç”¨ JAX çš„è°ƒè¯•æ ‡å¿—æŠ›å‡º Python é”™è¯¯

## ä½¿ç”¨ `jax.debug` è¿›è¡Œäº¤äº’å¼æ£€æŸ¥

**TL;DR** ä½¿ç”¨ `jax.debug.print()` åœ¨ `jax.jit`ã€`jax.pmap` å’Œ `pjit` è£…é¥°çš„å‡½æ•°ä¸­å°†å€¼æ‰“å°åˆ° stdoutï¼Œå¹¶ä½¿ç”¨ `jax.debug.breakpoint()` æš‚åœæ‰§è¡Œç¼–è¯‘å‡½æ•°ä»¥æ£€æŸ¥è°ƒç”¨å †æ ˆä¸­çš„å€¼ï¼š

```py
import jax
import jax.numpy as jnp

@jax.jit
def f(x):
  jax.debug.print("ğŸ¤¯ {x} ğŸ¤¯", x=x)
  y = jnp.sin(x)
  jax.debug.breakpoint()
  jax.debug.print("ğŸ¤¯ {y} ğŸ¤¯", y=y)
  return y

f(2.)
# Prints:
# ğŸ¤¯ 2.0 ğŸ¤¯
# Enters breakpoint to inspect values!
# ğŸ¤¯ 0.9092974662780762 ğŸ¤¯ 
```

ç‚¹å‡»æ­¤å¤„äº†è§£æ›´å¤šï¼

## ä½¿ç”¨ `jax.experimental.checkify` è¿›è¡ŒåŠŸèƒ½é”™è¯¯æ£€æŸ¥

**TL;DR** Checkify å…è®¸æ‚¨å‘ JAX ä»£ç æ·»åŠ  `jit` å¯ç”¨çš„è¿è¡Œæ—¶é”™è¯¯æ£€æŸ¥ï¼ˆä¾‹å¦‚è¶Šç•Œç´¢å¼•ï¼‰ã€‚ä½¿ç”¨ `checkify.checkify` è½¬æ¢ä»¥åŠç±»ä¼¼æ–­è¨€çš„ `checkify.check` å‡½æ•°ï¼Œå‘ JAX ä»£ç æ·»åŠ è¿è¡Œæ—¶æ£€æŸ¥ï¼š

```py
from jax.experimental import checkify
import jax
import jax.numpy as jnp

def f(x, i):
  checkify.check(i >= 0, "index needs to be non-negative!")
  y = x[i]
  z = jnp.sin(y)
  return z

jittable_f = checkify.checkify(f)

err, z = jax.jit(jittable_f)(jnp.ones((5,)), -1)
print(err.get())
# >> index needs to be non-negative! (check failed at <...>:6 (f)) 
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ checkify è‡ªåŠ¨æ·»åŠ å¸¸è§æ£€æŸ¥ï¼š

```py
errors = checkify.user_checks | checkify.index_checks | checkify.float_checks
checked_f = checkify.checkify(f, errors=errors)

err, z = checked_f(jnp.ones((5,)), 100)
err.throw()
# ValueError: out-of-bounds indexing at <..>:7 (f)

err, z = checked_f(jnp.ones((5,)), -1)
err.throw()
# ValueError: index needs to be non-negative! (check failed at <â€¦>:6 (f))

err, z = checked_f(jnp.array([jnp.inf, 1]), 0)
err.throw()
# ValueError: nan generated by primitive sin at <...>:8 (f) 
```

ç‚¹å‡»æ­¤å¤„äº†è§£æ›´å¤šï¼

## ä½¿ç”¨ JAX çš„è°ƒè¯•æ ‡å¿—æŠ›å‡º Python é”™è¯¯

**TL;DR** å¯ç”¨ `jax_debug_nans` æ ‡å¿—ï¼Œè‡ªåŠ¨æ£€æµ‹åœ¨ `jax.jit` ç¼–è¯‘çš„ä»£ç ä¸­ç”Ÿæˆ NaN æ—¶ï¼ˆä½†ä¸åœ¨ `jax.pmap` æˆ– `jax.pjit` ç¼–è¯‘çš„ä»£ç ä¸­ï¼‰ï¼Œå¹¶å¯ç”¨ `jax_disable_jit` æ ‡å¿—ä»¥ç¦ç”¨ JIT ç¼–è¯‘ï¼Œä»è€Œä½¿ç”¨ä¼ ç»Ÿçš„ Python è°ƒè¯•å·¥å…·å¦‚ `print` å’Œ `pdb`ã€‚

```py
import jax
jax.config.update("jax_debug_nans", True)

def f(x, y):
  return x / y
jax.jit(f)(0., 0.)  # ==> raises FloatingPointError exception! 
```

ç‚¹å‡»æ­¤å¤„äº†è§£æ›´å¤šï¼

é˜…è¯»æ›´å¤š

+   `jax.debug.print` å’Œ `jax.debug.breakpoint`

+   `checkify` è½¬æ¢

+   JAX è°ƒè¯•æ ‡å¿—
